<!DOCTYPE html>
<html>
<head>
    <title>Session & API Debug</title>
    <style>
        body {
            font-family: monospace;
            background: #1a1a2e;
            color: #fff;
            padding: 20px;
            line-height: 1.8;
        }
        .box {
            background: #0f0f1e;
            border: 1px solid #333;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { border-left: 4px solid #4caf50; }
        .error { border-left: 4px solid #f44336; }
        .info { border-left: 4px solid #4aa3ff; }
        button {
            background: #4aa3ff;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 3px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #2196F3; }
        code {
            background: #2a2a3e;
            padding: 3px 6px;
            border-radius: 3px;
            display: block;
            margin: 10px 0;
            overflow-x: auto;
        }
        pre {
            background: #2a2a3e;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>üîß Session & API Debug Console</h1>

    <div class="box info">
        <h2>1Ô∏è‚É£ Current Browser State</h2>
        <button onclick="showBrowserState()">Check Browser State</button>
        <pre id="browser-state">Click button to check...</pre>
    </div>

    <div class="box info">
        <h2>2Ô∏è‚É£ Server Session Check</h2>
        <button onclick="checkServerSession()">Check Server Session</button>
        <pre id="server-session">Click button to check...</pre>
    </div>

    <div class="box info">
        <h2>3Ô∏è‚É£ Test Each API</h2>
        <button onclick="testAPIWithDetails('getUserStats')">getUserStats</button>
        <button onclick="testAPIWithDetails('getHabits')">getHabits</button>
        <button onclick="testAPIWithDetails('getTasks')">getTasks</button>
        <pre id="api-results">Results appear here...</pre>
    </div>

    <div class="box info">
        <h2>4Ô∏è‚É£ Full Dashboard Simulation</h2>
        <button onclick="simulateDashboard()">Simulate Dashboard Load</button>
        <pre id="dashboard-sim">Results appear here...</pre>
    </div>

    <script>
        function showBrowserState() {
            const state = {
                localStorage: {
                    username: localStorage.getItem('username'),
                    all_keys: Object.keys(localStorage)
                },
                cookies: document.cookie || 'No cookies',
                sessionStorage: {
                    all_keys: Object.keys(sessionStorage)
                }
            };
            document.getElementById('browser-state').textContent = JSON.stringify(state, null, 2);
        }

        function checkServerSession() {
            const el = document.getElementById('server-session');
            el.textContent = 'Checking...';
            
            fetch('session-check.php')
                .then(r => r.json())
                .then(data => {
                    el.textContent = JSON.stringify(data, null, 2);
                })
                .catch(err => {
                    el.textContent = 'ERROR: ' + err.message + '\n' + err.stack;
                });
        }

        let testCount = 0;
        function testAPIWithDetails(action) {
            const el = document.getElementById('api-results');
            if (testCount++ === 0) el.textContent = '';
            
            const result = `\n=== Testing ${action} ===\n`;
            el.textContent += result + 'Loading...';
            
            fetch(`api.php?action=${action}`)
                .then(r => {
                    const text = `Status: ${r.status}\n`;
                    el.textContent += text;
                    return r.text();
                })
                .then(text => {
                    try {
                        const data = JSON.parse(text);
                        el.textContent += 'Response (JSON):\n' + JSON.stringify(data, null, 2) + '\n';
                    } catch (e) {
                        el.textContent += 'Response (Raw):\n' + text + '\nParse Error: ' + e.message + '\n';
                    }
                })
                .catch(err => {
                    el.textContent += 'FETCH ERROR: ' + err.message + '\n';
                });
        }

        function simulateDashboard() {
            const el = document.getElementById('dashboard-sim');
            el.textContent = 'Simulating dashboard load...\n\n';
            
            // First check session
            fetch('session-check.php')
                .then(r => r.json())
                .then(session => {
                    el.textContent += '1. Session Check: ' + (session.user_id ? 'LOGGED IN' : 'NOT LOGGED IN') + '\n';
                    el.textContent += '   User ID: ' + (session.user_id || 'null') + '\n\n';
                    
                    if (!session.user_id) {
                        el.textContent += 'PROBLEM: Not logged in! Redirect to auth.php would happen.\n';
                        return;
                    }
                    
                    // Then try the APIs
                    el.textContent += '2. Loading API data...\n';
                    return Promise.all([
                        fetch('api.php?action=getUserStats').then(r => r.json()),
                        fetch('api.php?action=getHabits').then(r => r.json()),
                        fetch('api.php?action=getTasks').then(r => r.json())
                    ]);
                })
                .then(([stats, habits, tasks]) => {
                    if (!stats) return;
                    el.textContent += '   getUserStats: ' + (stats.success ? 'SUCCESS' : 'FAIL: ' + stats.message) + '\n';
                    el.textContent += '   getHabits: ' + (habits.success ? 'SUCCESS (' + (habits.habits?.length || 0) + ' habits)' : 'FAIL: ' + habits.message) + '\n';
                    el.textContent += '   getTasks: ' + (tasks.success ? 'SUCCESS (' + (tasks.tasks?.length || 0) + ' tasks)' : 'FAIL: ' + tasks.message) + '\n\n';
                    
                    if (stats.success && habits.success && tasks.success) {
                        el.textContent += '‚úì Dashboard would load successfully!\n';
                    } else {
                        el.textContent += '‚úó Dashboard would show error\n';
                        if (!stats.success) el.textContent += '  - getUserStats failed\n';
                        if (!habits.success) el.textContent += '  - getHabits failed\n';
                        if (!tasks.success) el.textContent += '  - getTasks failed\n';
                    }
                })
                .catch(err => {
                    el.textContent += 'ERROR: ' + err.message + '\n';
                });
        }

        // Auto-run on load
        window.addEventListener('load', () => {
            showBrowserState();
            setTimeout(checkServerSession, 500);
        });
    </script>
</body>
</html>
